#! /usr/bin/env bash
set -euo pipefail # x

if get_input "Update brew?"; then
    brew update
    brew doctor
fi

if get_input "Dump brew bundle?"; then
    HOMEBREW_NO_AUTO_UPDATE=1 update_brew_packages
fi

if get_input "Dump plists?"; then
    plist_export
fi

check_git_status() {
    (
        cd "$1"
        git fetch
        OUTPUT=$(git status --porcelain)
        LINES=$(echo "$OUTPUT" | wc -l)
        if [[ "$LINES" -gt 1 ]]; then
            echo "$1 has changes:"
            echo "$OUTPUT"
        fi
    )
}

check_git_status "$(chezmoi src-path)"
check_git_status "$TOOLS_DIR"
check_git_status "$PRIVATE_TOOLS_DIR"

full_backup

day=$(date -u +%d)
if [[ "$day" -lt 10 ]]; then
    borgmatic check --progress --only repository --only archives --only data
fi

did=$(diskutil list -plist | scout paths -f plist "#AllDisksAndPartitions#" -v "value contains 'money'" | head -n 1 | awk -F'[^0-9]+' '{ print $2 }')
diskutil unmountDisk "/dev/disk$did"
