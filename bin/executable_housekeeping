#! /usr/bin/env bash
set -euo pipefail # x

if get_input "Update brew?"; then
    brew update
    brew doctor
fi

if get_input "Dump brew bundle?"; then
    HOMEBREW_NO_AUTO_UPDATE=1 update_brew_packages
fi

if get_input "Dump plists?"; then
    plist_export
fi

check_git_status() {
    (
        cd "$1"
        git fetch
        OUTPUT=$(git status --porcelain)
        LINES=$(echo "$OUTPUT" | wc -l)
        if [[ "$LINES" -gt 1 ]]; then
            echo "$1 has changes:"
            echo "$OUTPUT"
        fi
    )
}

check_git_status "$TOOLS_DIR"
check_git_status "$PRIVATE_TOOLS_DIR"

full_backup

echo "If this is the first backup of the month, run borgmatic check --progress --only repository --only archives --only data"
