#! /usr/bin/env bash
set -euo pipefail # x

FIRST_OF_MONTH=""
day=$(date -u +%d)
if [[ "$day" -lt 10 ]]; then
    FIRST_OF_MONTH="y"
fi

if [[ "$FIRST_OF_MONTH" = "y" ]]; then
    brew upgrade
    brew doctor
fi

# if get_input "Dump brew bundle?"; then
#     HOMEBREW_NO_AUTO_UPDATE=1 update_brew_packages
# fi

# if get_input "Dump plists?"; then
#     plist_export
# fi

check_git_status() {
    (
        cd "$1"
        git fetch
        OUTPUT=$(git status --porcelain)
        LINES=$(echo "$OUTPUT" | wc -l)
        if [[ "$LINES" -gt 1 ]]; then
            echo "$1 has changes:"
            echo "$OUTPUT"
        fi
    )
}

check_git_status "$(chezmoi source-path)"
check_git_status "$TOOLS_DIR"
check_git_status "$PRIVATE_TOOLS_DIR"

# TODO: only run this on personal machines
if [[ "$FIRST_OF_MONTH" = "y" ]]; then
    caffeinate -i borgmatic check --progress --only repository --only archives --only data
else
    caffeinate -i borgmatic --progress
fi

did=$(diskutil list -plist | scout paths -f plist "#AllDisksAndPartitions#" -v "value contains 'money'" | head -n 1 | awk -F'[^0-9]+' '{ print $2 }')
diskutil unmountDisk "/dev/disk$did"
