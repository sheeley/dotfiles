#! /usr/bin/env bash
set -euo pipefail # x

# ensure volume is mounted before doing anything
[ ! -d "$BORG_REPO" ] && echo "'$BORG_REPO' doesn't exist" && exit 1

# FIRST_OF_MONTH=""
# day=$(date -u +%d)
# if [[ "$day" -lt 10 ]]; then
#     FIRST_OF_MONTH="y"
# fi
# if [[ "$FIRST_OF_MONTH" = "y" ]]; then
# caffeinate -i borgmatic check --progress --only repository --only archives --only data
# else
# caffeinate -i borgmatic --progress
LOG_FILE="/tmp/borg.log"
rm -f "$LOG_FILE"
echo "for details, tail -f $LOG_FILE"
caffeinate -i borgmatic --progress --log-file-verbosity 2 --log-file "$LOG_FILE"
# fi

did=$(diskutil list -plist | scout paths -f plist "#AllDisksAndPartitions#" -v "value contains 'money'" | head -n 1 | awk -F'[^0-9]+' '{ print $2 }')
diskutil unmountDisk "/dev/disk$did"

# borgmatic --progress
# borg_backup
# rclone_backup

echo "Total time:"
gdate -u -d @${SECONDS} +"%T"
# say "Total time: $SECONDS seconds"
