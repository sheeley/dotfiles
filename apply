#! /usr/bin/env bash
set -eu

# TODO: verify this swap works
# HN=$(hostname | cut -d '.' -f 1)
HN=$(scutil --get HostName)

# TODO: is there a cleaner way of doing this?
VALID_HOSTNAMES=$(grep darwinConfigurations flake.nix | grep -o '".*"' | sed 's/"//g')

if [[ ! "${VALID_HOSTNAMES[*]}" =~ $HN ]]; then
	echo "change hostname: $HN"
	echo "sudo scutil --set HostName ..."
	exit 1
fi

nix build ".#darwinConfigurations.${HN}.system" --impure --extra-experimental-features "nix-command flakes"

if command -v nvd; then
	nvd diff /run/current-system result
	
	if command -v nix-diff; then
	# TODO: elide common lines https://github.com/Gabriella439/nix-diff/issues/42
		nix-diff /run/current-system result
	fi;

	if opt_out "Continue?"; then
		exit 0
	fi
fi

echo "darwin-rebuild"
./result/sw/bin/darwin-rebuild switch --flake . --impure

date >last-applied.txt